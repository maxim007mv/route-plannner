import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable } from 'rxjs';
import { map } from 'rxjs/operators';
import { RouteData } from '../models/route-data';

@Injectable({
  providedIn: 'root'
})
export class GeminiService {
  private readonly API_KEY = 'AIzaSyDb7rOQBhxw3xjOQOk2sGQhpX0lA2XQ_QI';
  private readonly API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent';

  constructor(private http: HttpClient) {}

  generateRoute(formData: RouteData): Observable<any> {
    const prompt = this.createRoutePrompt(formData);

    return this.http.post(`${this.API_URL}?key=${this.API_KEY}`, {
      contents: [{ parts: [{ text: prompt }] }]
    }).pipe(
      map((response: any) => response.candidates[0].content.parts[0].text)
    );
  }

  private createRoutePrompt(formData: any): string {
    return `–°–æ–∑–¥–∞–π –æ—á–µ–Ω—å –ø–æ–¥—Ä–æ–±–Ω—ã–π –ø–µ—à–µ—Ö–æ–¥–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç –ø–æ –ú–æ—Å–∫–≤–µ. –ú–∞—Ä—à—Ä—É—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–º –∏ –ª–æ–≥–∏—á–Ω—ã–º, —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞.

–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–∞—Ä—à—Ä—É—Ç–∞:
–£—á–∞—Å—Ç–Ω–∏–∫–∏: ${formData.withWhom}
–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞: ${formData.startTime}
–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${formData.duration} —á–∞—Å–∞
–ò–Ω—Ç–µ—Ä–µ—Å—ã: ${formData.interests.join(', ')}
–ë—é–¥–∂–µ—Ç –Ω–∞ –∫–∞—Ñ–µ: ${formData.cafeBudget}
–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç: ${formData.transportPreference}
–¢–µ–º–ø: ${formData.pace}
${formData.accessibility ? '–ù—É–∂–Ω–∞ –¥–æ—Å—Ç—É–ø–Ω–∞—è —Å—Ä–µ–¥–∞' : ''}
${formData.avoidCrowds ? '–ò–∑–±–µ–≥–∞—Ç—å –ª—é–¥–Ω—ã—Ö –º–µ—Å—Ç' : ''}
–ü–æ–∂–µ–ª–∞–Ω–∏—è: ${formData.additionalWishes}

–î–ª—è –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞ –º–∞—Ä—à—Ä—É—Ç–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å —Å–ª–µ–¥—É—é—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:
### –≠—Ç–∞–ø 1: [–ù–∞–∑–≤–∞–Ω–∏–µ –ª–æ–∫–∞—Ü–∏–∏ –∏–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏]
‚åö –í—Ä–µ–º—è: [–¢–æ—á–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å]
üó∫Ô∏è –ú–∞—Ä—à—Ä—É—Ç: [–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —É–ª–∏—Ü, –ø–æ–≤–æ—Ä–æ—Ç–æ–≤, –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤. –ù–∞–ø—Ä–∏–º–µ—Ä: "–í—ã–π–¥—è –∏–∑ –º–µ—Ç—Ä–æ, –ø–æ–≤–µ—Ä–Ω–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–æ –Ω–∞ —É–ª–∏—Ü—É X, –ø—Ä–æ–π–¥–∏—Ç–µ 200 –º–µ—Ç—Ä–æ–≤ –¥–æ Y, –¥–∞–ª–µ–µ..."]
üöï –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç: [–ü–æ–¥—Ä–æ–±–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∫–∞–∫ –¥–æ–±—Ä–∞—Ç—å—Å—è, –≤–∫–ª—é—á–∞—è –Ω–æ–º–µ—Ä–∞ –Ω—É–∂–Ω—ã—Ö –≤—ã—Ö–æ–¥–æ–≤ –∏–∑ –º–µ—Ç—Ä–æ, –∞–≤—Ç–æ–±—É—Å–æ–≤ –∏ —Ç.–¥.]
üëÄ –î–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: [–ü–æ–¥—Ä–æ–±–Ω—ã–π —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π —Å –∫—Ä–∞—Ç–∫–∏–º –æ–ø–∏—Å–∞–Ω–∏–µ–º –∫–∞–∂–¥–æ–π]
- [–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏]: [2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ –Ω–µ–π]
- [–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏]: [2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ –Ω–µ–π]
üç¥ –ì–¥–µ –ø–æ–µ—Å—Ç—å: [–°–ø–∏—Å–æ–∫ –∫–∞—Ñ–µ/—Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∫—É—Ö–Ω–∏ –∏ —Ü–µ–Ω–æ–≤–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞]
- [–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è]: [–∫—É—Ö–Ω—è, —Å—Ä–µ–¥–Ω–∏–π —á–µ–∫, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏]
- [–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è]: [–∫—É—Ö–Ω—è, —Å—Ä–µ–¥–Ω–∏–π —á–µ–∫, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏]
üìå –°–æ–≤–µ—Ç—ã: [–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —ç—Ç–æ–≥–æ —ç—Ç–∞–ø–∞]
‚úì [–°–æ–≤–µ—Ç –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–µ—â–µ–Ω–∏—è]
‚úì [–°–æ–≤–µ—Ç –ø–æ –±–∏–ª–µ—Ç–∞–º/–æ—á–µ—Ä–µ–¥—è–º]
‚úì [–î—Ä—É–≥–∏–µ –ø–æ–ª–µ–∑–Ω—ã–µ —Å–æ–≤–µ—Ç—ã]
üìç –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: [55.XXXXX, 37.XXXXX]

+ üì± –ü–æ–ª–µ–∑–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:
+ - [–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è]: [–î–ª—è —á–µ–≥–æ –ø—Ä–∏–≥–æ–¥–∏—Ç—Å—è –Ω–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ]
+
+ üé´ –ë–∏–ª–µ—Ç—ã –∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:
+ - [–ì–¥–µ –∫—É–ø–∏—Ç—å –±–∏–ª–µ—Ç—ã –æ–Ω–ª–∞–π–Ω]
+ - [–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã]
+ - [–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏ —Å–∫–∏–¥–∫–∏]
+
+ ‚ö° –õ–∞–π—Ñ—Ö–∞–∫–∏:
+ - [–ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å –æ—á–µ—Ä–µ–¥–µ–π]
+ - [–õ—É—á—à–∏–µ —Ç–æ—á–∫–∏ –¥–ª—è —Ñ–æ—Ç–æ]
+ - [–°–µ–∫—Ä–µ—Ç–Ω—ã–µ –º–µ—Å—Ç–∞ –ø–æ–±–ª–∏–∑–æ—Å—Ç–∏]
+
+ üå¶Ô∏è –ü–ª–∞–Ω –ë (–ø—Ä–∏ –ø–ª–æ—Ö–æ–π –ø–æ–≥–æ–¥–µ):
+ - [–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Å—Ç–∞]
+ - [–ö—Ä—ã—Ç—ã–µ –ª–æ–∫–∞—Ü–∏–∏ –ø–æ–±–ª–∏–∑–æ—Å—Ç–∏]

–í–∞–∂–Ω–æ:
1. –£—á–∏—Ç—ã–≤–∞–π –≤—Ä–µ–º—è —Å—É—Ç–æ–∫ –∏ —Å–µ–∑–æ–Ω
2. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–π –≤—Ä–µ–º—è –Ω–∞ –ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É –ª–æ–∫–∞—Ü–∏—è–º–∏
3. –î–æ–±–∞–≤–ª—è–π –≤—Ä–µ–º—è –Ω–∞ –æ—Å–º–æ—Ç—Ä –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π
4. –£—á–∏—Ç—ã–≤–∞–π –ø–µ—Ä–µ—Ä—ã–≤—ã –Ω–∞ –æ—Ç–¥—ã—Ö
5. –ü—Ä–µ–¥–ª–∞–≥–∞–π –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã –Ω–∞ —Å–ª—É—á–∞–π –ø–ª–æ—Ö–æ–π –ø–æ–≥–æ–¥—ã
6. –£–∫–∞–∑—ã–≤–∞–π –º–µ—Å—Ç–∞ –¥–ª—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
7. –î–æ–±–∞–≤–ª—è–π –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ —Ñ–∞–∫—Ç—ã

–í –∫–æ–Ω—Ü–µ –º–∞—Ä—à—Ä—É—Ç–∞ –¥–æ–±–∞–≤—å:
üó∫Ô∏è [–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –º–∞—Ä—à—Ä—É—Ç –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç–∞—Ö](https://yandex.ru/maps/?api-key=4527e6e0-3b7e-4ade-9b8f-34ac356e812c&ll=37.6173,55.7558&z=15)'`;
  }
}
